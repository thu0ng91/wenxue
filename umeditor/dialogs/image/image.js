!function(){var a=UM.utils,b=UM.browser,c={checkURL:function(b){return b?(b=a.trim(b),b.length<=0?!1:(0!==b.search(/http:\/\/|https:\/\//)&&(b+="http://"),b=b.replace(/\?[\s\S]*$/,""),/(.gif|.jpg|.jpeg|.png)$/i.test(b)?b:!1)):!1},getAllPic:function(a,b,c){var d=this,e=[],f=$(a,b);return $.each(f,function(a,b){return $(b).removeAttr("width").removeAttr("height"),b.width>c.options.initialFrameWidth&&d.scale(b,c.options.initialFrameWidth-parseInt($(c.body).css("padding-left"))-parseInt($(c.body).css("padding-right"))),e.push({width:b.width,height:b.height,_src:b.src,src:b.src})}),e},scale:function(a,b,c,d){var g,e=0,f=0,h=a.width||c,i=a.height||d;return(h>b||i>b)&&(h>=i?(e=h-b)&&(g=(e/h).toFixed(2),a.height=i-i*g,a.width=b):(f=i-b)&&(g=(f/i).toFixed(2),a.width=h-h*g,a.height=b)),this},close:function(a){return a.css({top:(a.parent().height()-a.height())/2,left:(a.parent().width()-a.width())/2}).prev().on("click",function(){$(this).parent().remove().hasClass("edui-image-upload-item")&&(d.showCount--,d.updateView())}),this},createImgBase64:function(a,c,d){if(b.webkit)a.src=window.webkitURL.createObjectURL(c);else if(b.gecko)a.src=window.URL.createObjectURL(c);else{var e=new FileReader;e.onload=function(){a.src=this.result,d.append(a)},e.readAsDataURL(c)}},callback:function(a,b,e,f){if("SUCCESS"==f){d.showCount++;var h=$("<img src='"+a.options.imagePath+e+"' class='edui-image-pic' />"),i=$("<div class='edui-image-item edui-image-upload-item'><div class='edui-image-close'></div></div>").append(h);$("#edui-image-Jupload2",b).length<1?($("#edui-image-Jcontent",b).append(i),d.render("#edui-image-Jcontent",2).config("#edui-image-Jupload2")):$("#edui-image-Jupload2",b).before(i).show(),h.on("load",function(){c.scale(this,120),c.close($(this))})}else g.showTip(f),window.setTimeout(function(){g.hideTip()},3e3);d.toggleMask()}},d={showCount:0,uploadTpl:'<div class="edui-image-upload%%" id="edui-image-Jupload%%"><input  id="uploadfile"  name="uploadfile" type="file" multiple="true"/><div id="fileQueue"></div><iframe name="up" style="display: none"></iframe></div>',init:function(a,b){var c=this;return c.editor=a,c.dialog=b,c.render("#edui-image-Jlocal",1),c.config("#edui-image-Jupload1"),c.submit(),c.drag(),$("#edui-image-Jupload1").hover(function(){$(".edui-image-icon",this).toggleClass("hover")}),UM.browser.ie&&UM.browser.version<=9||$("#edui-image-JdragTip",c.dialog).css("display","block"),c},render:function(a,b){var c=this;return $(a,c.dialog).append($(c.uploadTpl.replace(/%%/g,b))),c},config:function(a){var b=this,c=b.editor.options.imageUrl;return c=c+(-1==c.indexOf("?")?"?":"&")+"editorid="+b.editor.id,$("form",$(a,b.dialog)).attr("action",c),b},submit:function(a){var b=this,c=$('<input style="filter: alpha(opacity=0);" class="edui-image-file" type="file" hidefocus="" name="upfile" accept="image/gif,image/jpeg,image/png,image/jpg,image/bmp">'),c=c[0];return $("#edui-dialog-image").find("#control_footer").hide(),myUploadify(),$(b.dialog).delegate(".edui-image-file","change",function(){this.parentNode&&($(this).parent()[0].submit(),d.updateInput(c),b.toggleMask("Loading...."),a&&a())}),b},updateInput:function(a){$(".edui-image-file",this.dialog).each(function(b,c){c.parentNode.replaceChild(a.cloneNode(!0),c)})},updateView:function(){0===d.showCount&&($(".edui-image-upload2",this.dialog).hide(),$(".edui-image-upload1",this.dialog).show())},drag:function(){var a=this;UM.browser.ie9below||a.dialog.find("#edui-image-Jcontent").on("drop",function(b){var d=b.originalEvent.dataTransfer.files,e=document.createElement("img"),f=!1;$.each(d,function(b,g){var h,i;/^image/.test(g.type)&&(c.createImgBase64(e,g,a.dialog),h=new XMLHttpRequest,h.open("post",a.editor.getOpt("imageUrl")+"?type=ajax",!0),h.setRequestHeader("X-Requested-With","XMLHttpRequest"),i=new FormData,i.append(a.editor.getOpt("imageFieldName"),g),h.send(i),h.addEventListener("load",function(f){c.callback(a.editor,a.dialog,f.target.response,"SUCCESS"),b==d.length-1&&$(e).remove()}),f=!0)}),f&&(b.preventDefault(),a.toggleMask("Loading...."))}).on("dragover",function(a){a.preventDefault()})},toggleMask:function(){var b=this;return b}},e={init:function(a,b){var c=this;c.editor=a,c.dialog=b,c.initEvt()},initEvt:function(){var b,a=this,d=$("#edui-image-JsearchTxt",a.dialog);$("#edui-image-JsearchAdd",a.dialog).on("click",function(){b=c.checkURL(d.val()),b&&$("<img src='"+b+"' class='edui-image-pic' />").on("load",function(){var b=$("<div class='edui-image-item'><div class='edui-image-close'></div></div>").append(this);$("#edui-image-JsearchRes",a.dialog).append(b),c.scale(this,120),b.width($(this).width()),c.close($(this)),d.val("")})}).hover(function(){$(this).toggleClass("hover")})}},f=null,g=null;UM.registerWidget("image",{tpl:'<link rel="stylesheet" type="text/css" href="<%=image_url%>image.css"><div id="edui-image-Jwrapper" class="edui-image-wrapper"><ul class="edui-tab-nav" style="display:none"><li class="edui-tab-item active"><a href="#edui-image-Jlocal" class="edui-tab-text"><%=lang_tab_local%></a></li></ul><div class="edui-tab-content"><div id="edui-image-Jlocal" class="edui-tab-pane active"><div class="edui-image-content" id="edui-image-Jcontent"></div><div class="edui-image-mask" id="edui-image-Jmask"></div></div></div></div>',initContent:function(a,b){var f,c=a.getLang("image")["static"],e=$.extend({},c,{image_url:UMEDITOR_CONFIG.UMEDITOR_HOME_URL+"dialogs/image/"});d.showCount=0,c&&(f=$.parseTmpl(this.tpl,e)),g=b.edui(),this.root().html(f)},initEvent:function(a,b){f=$.eduitab({selector:"#edui-image-Jwrapper"}).edui().on("beforeshow",function(a){a.stopPropagation()}),d.init(a,b),e.init(a,b)},buttons:{ok:{exec:function(a,b){var g,d="",e=f.activate();0==e?d="#edui-image-Jcontent .edui-image-pic":1==e&&(d="#edui-image-JsearchRes .edui-image-pic"),g=c.getAllPic(d,b,a),-1!=e&&a.execCommand("insertimage",g)}},cancel:{}},width:400},function(a,b,d,e){c.callback(a,b,d,e)})}();